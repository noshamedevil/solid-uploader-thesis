<!DOCTYPE html>
<html lang="en">
<head>
  <title>Solid File Uploader</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }

    h2, h3 {
      margin-bottom: 10px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin: 6px 0;
    }

    button {
      margin-left: 8px;
    }

    #logout-btn {
      float: right;
      background: #f33;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>
    Upload to Solid Pod
    <button id="logout-btn">Logout</button>
  </h2>

  <p id="welcome-msg" style="color: #333;"></p>

  <form id="upload-form">
    <input type="file" id="fileInput" />
    <button type="submit">Upload</button>
  </form>

  <h3>Uploaded Files</h3>
  <ul id="file-list"></ul>

  <script type="module">
    const form = document.getElementById("upload-form");
    const fileList = document.getElementById("file-list");

    document.getElementById("logout-btn").onclick = async () => {
      const res = await fetch("/logout");
      const msg = await res.text();
      alert(msg);
      window.location = "/login.html";
    };

    async function loadUser() {
      try {
        const res = await fetch("/me");
        const data = await res.json();
        document.getElementById("welcome-msg").textContent = `Welcome, ${data.email}`;
      } catch {
        window.location = "/login.html";
      }
    }

    loadUser();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = document.getElementById("fileInput").files[0];
      if (!file) {
        alert("Please choose a file first.");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("/upload", {
          method: "POST",
          body: formData,
        });

        const result = await res.json();
        alert(result.message || "âœ… Upload complete");

        const url = result.url;
        const fileName = decodeURIComponent(url.split("/").pop());

        const li = document.createElement("li");

        const link = document.createElement("a");
        link.href = url;
        link.target = "_blank";
        link.textContent = fileName;

        const copyViewLinkBtn = document.createElement("button");
        copyViewLinkBtn.textContent = "ðŸ” Copy Original Link";
        copyViewLinkBtn.onclick = () => {
          const encryptedName = fileName + ".enc";
          const viewLink = `${location.origin}/view?file=${encodeURIComponent(encryptedName)}`;
          navigator.clipboard.writeText(viewLink);
          alert("ðŸ” Original view link copied to clipboard!");
        };

        const copyBtn = document.createElement("button");
        copyBtn.textContent = "ðŸ”— Copy Link";
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(url);
          alert("ðŸ”— Redacted Pod link copied to clipboard!");
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "ðŸ—‘ï¸ Delete";
        deleteBtn.onclick = async () => {
          if (confirm(`Delete "${fileName}" from your Solid Pod?`)) {
            const res = await fetch(`/file?url=${encodeURIComponent(url)}`, {
              method: "DELETE",
            });
            const msg = await res.text();
            alert(msg);
            li.remove();
          }
        };

        li.appendChild(link);
        li.appendChild(copyViewLinkBtn);
        li.appendChild(copyBtn);
        li.appendChild(deleteBtn);
        fileList.appendChild(li);
      } catch (err) {
        alert("Upload failed: " + err.message);
      }
    });
  </script>
</body>
</html>
